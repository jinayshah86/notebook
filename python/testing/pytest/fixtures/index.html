<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is mickey mouse's notebook"><meta name=author content="Mickey Mouse"><link href=https://jinayshah.netlify.com/python/testing/pytest/fixtures/ rel=canonical><link href=../parametrization/ rel=prev><link href=../plugins/ rel=next><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.3, mkdocs-material-9.1.18"><title>Fixtures - Mickey Mouse's Notebook</title><link rel=stylesheet href=../../../../assets/stylesheets/main.26e3688c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,300i,400,400i,700,700i%7CHack:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto Mono";--md-code-font:"Hack"}</style><link rel=stylesheet href=../../../../css/timeago.css><link rel=stylesheet href=https://unpkg.com/mermaid@7.1.2/dist/mermaid.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#introduction class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title="Mickey Mouse's Notebook" class="md-header__button md-logo" aria-label="Mickey Mouse's Notebook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Mickey Mouse's Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Fixtures </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Mickey Mouse's Notebook" class="md-nav__button md-logo" aria-label="Mickey Mouse's Notebook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Mickey Mouse's Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../functions/ class=md-nav__link> Functions </a> </li> <li class=md-nav__item> <a href=../../../decorators/ class=md-nav__link> Decorators </a> </li> <li class=md-nav__item> <a href=../../../oop/ class=md-nav__link> OOP </a> </li> <li class=md-nav__item> <a href=../../../iterators/ class=md-nav__link> Iterators </a> </li> <li class=md-nav__item> <a href=../../../files/ class=md-nav__link> Working with files </a> </li> <li class=md-nav__item> <a href=../../../custom-json/ class=md-nav__link> Custom JSON Encoder/Decoder </a> </li> <li class=md-nav__item> <a href=../../../pickling/ class=md-nav__link> Pickling </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8 checked> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex=0> Testing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=true> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Testing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../introduction/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8_2 checked> <label class=md-nav__link for=__nav_2_8_2 id=__nav_2_8_2_label tabindex=0> Pytest <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_8_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_8_2> <span class="md-nav__icon md-icon"></span> Pytest </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../tests/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../markers/ class=md-nav__link> Markers </a> </li> <li class=md-nav__item> <a href=../parametrization/ class=md-nav__link> Parametrization </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Fixtures <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Fixtures </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#problem class=md-nav__link> Problem </a> </li> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> </li> <li class=md-nav__item> <a href=#setupteardown class=md-nav__link> Setup/teardown </a> </li> <li class=md-nav__item> <a href=#composability class=md-nav__link> Composability </a> </li> <li class=md-nav__item> <a href=#conftestpy class=md-nav__link> conftest.py </a> </li> <li class=md-nav__item> <a href=#prefer-local-imports-in-conftest-files class=md-nav__link> Prefer local imports in conftest files </a> </li> <li class=md-nav__item> <a href=#renaming-fixtures class=md-nav__link> Renaming fixtures </a> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> Scope </a> </li> <li class=md-nav__item> <a href=#autouse class=md-nav__link> Autouse </a> </li> <li class=md-nav__item> <a href=#pytestmarkusefixtures class=md-nav__link> @pytest.mark.usefixtures </a> </li> <li class=md-nav__item> <a href=#parametrizing-fixtures class=md-nav__link> Parametrizing fixtures </a> </li> <li class=md-nav__item> <a href=#using-marks-from-fixtures class=md-nav__link> Using marks from fixtures </a> </li> <li class=md-nav__item> <a href=#built-in-fixtures class=md-nav__link> Built-in fixtures </a> <nav class=md-nav aria-label="Built-in fixtures"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tmpdir class=md-nav__link> tmpdir </a> </li> <li class=md-nav__item> <a href=#tmpdir_factory class=md-nav__link> tmpdir_factory </a> </li> <li class=md-nav__item> <a href=#monkeypatch class=md-nav__link> monkeypatch </a> </li> <li class=md-nav__item> <a href=#capsys class=md-nav__link> capsys </a> </li> <li class=md-nav__item> <a href=#capfd class=md-nav__link> capfd </a> </li> <li class=md-nav__item> <a href=#capsysbinarycapfdbinary class=md-nav__link> capsysbinary/capfdbinary </a> </li> <li class=md-nav__item> <a href=#request class=md-nav__link> request </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../plugins/ class=md-nav__link> Plugins </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tox/ class=md-nav__link> Tox </a> </li> <li class=md-nav__item> <a href=../../coverage/ class=md-nav__link> Coverage </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../exceptions/ class=md-nav__link> Exceptions </a> </li> <li class=md-nav__item> <a href=../../../profiling/ class=md-nav__link> Profiling </a> </li> <li class=md-nav__item> <a href=../../../concurrency/ class=md-nav__link> Concurrent Execution </a> </li> <li class=md-nav__item> <a href=../../../logging/ class=md-nav__link> Logging </a> </li> <li class=md-nav__item> <a href=../../../references/ class=md-nav__link> References </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#problem class=md-nav__link> Problem </a> </li> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> </li> <li class=md-nav__item> <a href=#setupteardown class=md-nav__link> Setup/teardown </a> </li> <li class=md-nav__item> <a href=#composability class=md-nav__link> Composability </a> </li> <li class=md-nav__item> <a href=#conftestpy class=md-nav__link> conftest.py </a> </li> <li class=md-nav__item> <a href=#prefer-local-imports-in-conftest-files class=md-nav__link> Prefer local imports in conftest files </a> </li> <li class=md-nav__item> <a href=#renaming-fixtures class=md-nav__link> Renaming fixtures </a> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> Scope </a> </li> <li class=md-nav__item> <a href=#autouse class=md-nav__link> Autouse </a> </li> <li class=md-nav__item> <a href=#pytestmarkusefixtures class=md-nav__link> @pytest.mark.usefixtures </a> </li> <li class=md-nav__item> <a href=#parametrizing-fixtures class=md-nav__link> Parametrizing fixtures </a> </li> <li class=md-nav__item> <a href=#using-marks-from-fixtures class=md-nav__link> Using marks from fixtures </a> </li> <li class=md-nav__item> <a href=#built-in-fixtures class=md-nav__link> Built-in fixtures </a> <nav class=md-nav aria-label="Built-in fixtures"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tmpdir class=md-nav__link> tmpdir </a> </li> <li class=md-nav__item> <a href=#tmpdir_factory class=md-nav__link> tmpdir_factory </a> </li> <li class=md-nav__item> <a href=#monkeypatch class=md-nav__link> monkeypatch </a> </li> <li class=md-nav__item> <a href=#capsys class=md-nav__link> capsys </a> </li> <li class=md-nav__item> <a href=#capfd class=md-nav__link> capfd </a> </li> <li class=md-nav__item> <a href=#capsysbinarycapfdbinary class=md-nav__link> capsysbinary/capfdbinary </a> </li> <li class=md-nav__item> <a href=#request class=md-nav__link> request </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Fixtures</h1> <h3 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h3> <p>Tests in the real world often need to create resources or data to work on: a temporary directory to output some files to, a database connection to test the I/O layer of an application, a web server for integration testing. Those are all examples of resources that are required in more complex testing scenarios. More complex resources often need to be cleaned up at the end of the test session: removing a temporary directory, cleaning up and disconnecting from a database, shutting down a web server. Also, these resources should be easily shared across tests, because during testing we often need to reuse a resource for different test scenarios. Some resources are costly to create, but because they are immutable or can be restored to a pristine state, they should be created only once and shared with all the tests that require it, only being destroyed when the last test that needs them finishes. </p> <p>All of the previous requirements and more are covered by one of the most important of pytest&rsquo;s features: <strong>fixtures</strong>.</p> <h3 id=problem>Problem<a class=headerlink href=#problem title="Permanent link">&para;</a></h3> <p>Most tests need some kind of data or resource to operate on: <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_highest_rated</span><span class=p>():</span>
    <span class=n>series</span> <span class=o>=</span> <span class=p>[</span>
        <span class=p>(</span><span class=s2>&quot;The Office&quot;</span><span class=p>,</span> <span class=mi>2005</span><span class=p>,</span> <span class=mf>8.8</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Scrubs&quot;</span><span class=p>,</span> <span class=mi>2001</span><span class=p>,</span> <span class=mf>8.4</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;IT Crowd&quot;</span><span class=p>,</span> <span class=mi>2006</span><span class=p>,</span> <span class=mf>8.5</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Parks and Recreation&quot;</span><span class=p>,</span> <span class=mi>2009</span><span class=p>,</span> <span class=mf>8.6</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Seinfeld&quot;</span><span class=p>,</span> <span class=mi>1989</span><span class=p>,</span> <span class=mf>8.9</span><span class=p>),</span>
    <span class=p>]</span>
    <span class=k>assert</span> <span class=n>highest_rated</span><span class=p>(</span><span class=n>series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Seinfeld&quot;</span>

<span class=k>def</span> <span class=nf>test_oldest</span><span class=p>():</span>
    <span class=n>series</span> <span class=o>=</span> <span class=p>[</span>
        <span class=p>(</span><span class=s2>&quot;The Office&quot;</span><span class=p>,</span> <span class=mi>2005</span><span class=p>,</span> <span class=mf>8.8</span><span class=p>),</span>
        <span class=o>...</span><span class=p>,</span>
    <span class=p>]</span> <span class=c1># same data as above</span>
    <span class=k>assert</span> <span class=n>oldest</span><span class=p>(</span><span class=n>series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Seinfeld&quot;</span>
</code></pre></div></p> <p>Here, we have a list of (<code>series name</code>, <code>year</code>, <code>rating</code>) tuples that we use to test the <code>highest_rated</code> function. Inlining data into the test code as we do here works well for isolated tests, but often you have a dataset that can be used by multiple tests. One solution would be to copy over the dataset to each test, like it&rsquo;s done in the above code. But this gets old quicklyâ€”plus, copying and pasting things around will hurt maintainability in the long run, for example, if the data layout changes (adding a new item to the tuple like the cast size, for example).</p> <h3 id=solution>Solution<a class=headerlink href=#solution title="Permanent link">&para;</a></h3> <p><strong>Fixtures</strong> are used to provide resources that test the functions and methods we need to execute. They are created using normal Python functions and the <code>@pytest.fixture</code> decorator:</p> <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>comedy_series</span><span class=p>():</span>
    <span class=k>return</span> <span class=p>[</span>
        <span class=p>(</span><span class=s2>&quot;The Office&quot;</span><span class=p>,</span> <span class=mi>2005</span><span class=p>,</span> <span class=mf>8.8</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Scrubs&quot;</span><span class=p>,</span> <span class=mi>2001</span><span class=p>,</span> <span class=mf>8.4</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;IT Crowd&quot;</span><span class=p>,</span> <span class=mi>2006</span><span class=p>,</span> <span class=mf>8.5</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Parks and Recreation&quot;</span><span class=p>,</span> <span class=mi>2009</span><span class=p>,</span> <span class=mf>8.6</span><span class=p>),</span>
        <span class=p>(</span><span class=s2>&quot;Seinfeld&quot;</span><span class=p>,</span> <span class=mi>1989</span><span class=p>,</span> <span class=mf>8.9</span><span class=p>),</span>
    <span class=p>]</span>
</code></pre></div> <p>Here, we are creating a fixture named <code>comedy_series</code>, which returns the same list we were using in the previous section.</p> <p>Tests can access fixtures by declaring the fixture name in their <strong>parameter</strong> list. The test function then receives the return value of the fixture function as a parameter. Here is the <code>comedy_series</code> fixture in action:</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_highest_rated</span><span class=p>(</span><span class=n>comedy_series</span><span class=p>):</span>
    <span class=k>assert</span> <span class=n>highest_rated</span><span class=p>(</span><span class=n>comedy_series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Seinfeld&quot;</span>

<span class=k>def</span> <span class=nf>test_oldest</span><span class=p>(</span><span class=n>comedy_series</span><span class=p>):</span>
    <span class=k>assert</span> <span class=n>oldest</span><span class=p>(</span><span class=n>comedy_series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Seinfeld&quot;</span>
</code></pre></div> <p>Here&rsquo;s how things work:</p> <ul> <li>Pytest looks at the test function parameters before calling it. Here, we have one parameter: <code>comedy_series</code>.</li> <li>For each parameter, pytest gets the fixture function of <strong>same name</strong> and executes it.</li> <li>The return value of each fixture function becomes a named parameter, and the test function is called.</li> </ul> <p>Note that <code>test_highest_rated</code> and <code>test_oldest</code> each get their own copy of the comedy series list, so they don&rsquo;t risk interfering with each other if they change the list inside the test.</p> <p>It is also possible to create fixtures in classes using methods:</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>Test</span><span class=p>:</span>

    <span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
    <span class=k>def</span> <span class=nf>drama_series</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=p>[</span>
            <span class=p>(</span><span class=s2>&quot;The Mentalist&quot;</span><span class=p>,</span> <span class=mi>2008</span><span class=p>,</span> <span class=mf>8.1</span><span class=p>),</span>
            <span class=p>(</span><span class=s2>&quot;Game of Thrones&quot;</span><span class=p>,</span> <span class=mi>2011</span><span class=p>,</span> <span class=mf>9.5</span><span class=p>),</span>
            <span class=p>(</span><span class=s2>&quot;The Newsroom&quot;</span><span class=p>,</span> <span class=mi>2012</span><span class=p>,</span> <span class=mf>8.6</span><span class=p>),</span>
            <span class=p>(</span><span class=s2>&quot;Cosmos&quot;</span><span class=p>,</span> <span class=mi>1980</span><span class=p>,</span> <span class=mf>9.3</span><span class=p>),</span>
        <span class=p>]</span>

    <span class=o>...</span>

    <span class=k>def</span> <span class=nf>test_highest_rated</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>drama_series</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>highest_rated</span><span class=p>(</span><span class=n>drama_series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Game of Thrones&quot;</span>

    <span class=k>def</span> <span class=nf>test_oldest</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>drama_series</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>oldest</span><span class=p>(</span><span class=n>drama_series</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;Cosmos&quot;</span>
</code></pre></div> <p>Fixtures defined in test classes are only accessible by test methods of the class or subclasses. Note that test classes might have other non-test methods, like any other class.</p> <h3 id=setupteardown>Setup/teardown<a class=headerlink href=#setupteardown title="Permanent link">&para;</a></h3> <p>As we&rsquo;ve seen in the introduction, it is very common for resources that are used in testing to require some sort of clean up after a test is done with them. One example for such would be generate comedy_series data from a csv. <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>comedy_series</span><span class=p>():</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&quot;series.csv&quot;</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
        <span class=k>yield</span> <span class=nb>list</span><span class=p>(</span><span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>))</span>
</code></pre></div></p> <p>By using <code>yield</code> instead of <code>return</code>, this is what happens:</p> <ul> <li>The fixture function is called</li> <li>It executes until the yield statement, where it pauses and yields the fixture value</li> <li>The test executes, receiving the fixture value as parameter</li> <li>Regardless of whether the test passes or fails, the function is resumed so it can perform its teardown actions</li> </ul> <p>The file will be closed automatically by the with statement after the test completes.</p> <h3 id=composability>Composability<a class=headerlink href=#composability title="Permanent link">&para;</a></h3> <p>Suppose we receive a new series.csv file that now contains a much larger number of TV series, including the comedy series we had before and many other genres as well. We want to use this new data for some other tests, but we would like to keep existing tests working as they did previously.</p> <p>Fixtures in pytest can easily depend on other fixtures just by declaring them as parameters. Using this property, we are able to create a new series fixture that reads all the data from <code>series.csv</code> (which now contains more genres), and change our <code>comedy_series</code> fixture to filter out only comedy series: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>series</span><span class=p>():</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&quot;series.csv&quot;</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
        <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>))</span>

<span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>comedy_series</span><span class=p>(</span><span class=n>series</span><span class=p>):</span>
    <span class=k>return</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>series</span> <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=n>GENRE</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;comedy&quot;</span><span class=p>]</span>
</code></pre></div></p> <p>Note that, because of those characteristics, fixtures are a prime example of dependency injection, which is a technique where a function or an object declares its dependencies, but otherwise doesn&rsquo;t know or care how those dependencies will be created, or by who. This makes them extremely modular and reusable.</p> <h3 id=conftestpy><code>conftest.py</code><a class=headerlink href=#conftestpy title="Permanent link">&para;</a></h3> <p>Suppose we need to use our <code>comedy_series</code> fixture from the previous section in other test modules. In pytest, sharing fixtures is easily done by just moving the fixture code to a <code>conftest.py</code> file.</p> <p>A <code>conftest.py</code> file is a normal Python module, except that it is loaded automatically by pytest, and any fixtures defined in it are available to test modules in the same directory and below automatically. Consider this test module hierarchy: <div class=highlight><pre><span></span><code>tests/
 +-- ratings/
    +-- series.csv
    +-- test_ranking.py
 +-- io/
    +-- conftest.py
    +-- test_formats.py
 +-- conftest.py
</code></pre></div></p> <p>The <code>tests/conftest.py</code> file is at the root of the hierarchy, so any fixtures defined on it are automatically available to all other test modules in this project. Fixtures in <code>tests/io/conftest.py</code> will be available only to modules at and below <code>tests/io</code>, so only to <code>test_formats.py</code>.</p> <h3 id=prefer-local-imports-in-conftest-files>Prefer local imports in conftest files<a class=headerlink href=#prefer-local-imports-in-conftest-files title="Permanent link">&para;</a></h3> <p><code>conftest.py</code> files are imported during collection, so they directly affect your experience when running tests from the command line. For this reason, I suggest using local imports in <code>conftest.py</code> files as often as possible, to keep import times low.</p> <p>So, don&rsquo;t use this: <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>pytest</span>
<span class=kn>import</span> <span class=nn>tempfile</span>
<span class=kn>from</span> <span class=nn>myapp</span> <span class=kn>import</span> <span class=n>setup</span>

<span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>setup_app</span><span class=p>():</span>
    <span class=o>...</span>
</code></pre></div></p> <p>Prefer local imports: <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>pytest</span>

<span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>setup_app</span><span class=p>():</span>
    <span class=kn>import</span> <span class=nn>tempfile</span>
    <span class=kn>from</span> <span class=nn>myapp</span> <span class=kn>import</span> <span class=n>setup</span>
    <span class=o>...</span>
</code></pre></div></p> <p>This practice has a noticeable impact on test startup in large test suites.</p> <h3 id=renaming-fixtures>Renaming fixtures<a class=headerlink href=#renaming-fixtures title="Permanent link">&para;</a></h3> <p>The <code>@pytest.fixture</code> decorator accepts a <code>name</code> parameter that can be used to specify a name for the fixture, different from the fixture function: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&quot;venv_dir&quot;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>_venv_dir</span><span class=p>():</span>
    <span class=o>...</span>
</code></pre></div></p> <p>This is useful, because there are some annoyances that might affect users when using fixtures declared in the same module as the test functions that use them:</p> <ul> <li>If users forget to declare the fixture in the parameter list of a test function, they will get a <code>NameError</code> instead of the fixture function object (because they are in the same module).</li> <li>Some linters complain that the test function parameter is shadowing the fixture function.</li> </ul> <p>You might adopt this as a good practice in your team if the previous annoyances are frequent. Keep in mind that these problems only happen with fixtures defined in test modules, not in <code>conftest.py</code> files.</p> <h3 id=scope>Scope<a class=headerlink href=#scope title="Permanent link">&para;</a></h3> <p>The scope of a fixture defines when the fixture should be cleaned up. While the fixture is not cleaned up, tests requesting the fixture will receive the same fixture value.</p> <p>The <code>scope</code> parameter of the <code>@pytest.fixture</code> decorator is used to set the fixture&rsquo;s scope: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s2>&quot;session&quot;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>db_connection</span><span class=p>():</span>
    <span class=o>...</span>
</code></pre></div></p> <p>The following scopes are available:</p> <ul> <li><code>scope="session"</code>: fixture is teardown when all tests finish.</li> <li><code>scope="module"</code>: fixture is teardown when the last test function of a module finishes.</li> <li><code>scope="class"</code>: fixture is teardown when the last test method of a class finishes.</li> <li><code>scope="function"</code>: fixture is teardown when the test function requesting it finishes. This is the default.</li> </ul> <p>It is important to emphasize that, regardless of scope, each fixture will be created only when a test function requires it. For example, session-scoped fixtures are not necessarily created at the start of the session, but only when the first test that requests it is about to be called. This makes sense when you consider that not all tests might need a session-scoped fixture, and there are various forms to run only a subset of tests, as we have seen in previous chapters.</p> <h3 id=autouse>Autouse<a class=headerlink href=#autouse title="Permanent link">&para;</a></h3> <p>It is possible to apply a fixture to all of the tests in a hierarchy, even if the tests don&rsquo;t explicitly request a fixture, by passing <code>autouse=True</code> to the <code>@pytest.fixture</code> decorator. This is useful when we need to apply a side-effect before and/or after each test unconditionally. <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>autouse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>setup_dev_environment</span><span class=p>():</span>
    <span class=n>previous</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;APP_ENV&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;APP_ENV&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;TESTING&#39;</span>
    <span class=k>yield</span>
    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;APP_ENV&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>previous</span>
</code></pre></div></p> <p>If a test can access an autouse fixture by declaring it in the parameter list, the autouse fixture will be automatically used by that test. Note that it is possible for a test function to add the autouse fixture to its parameter list if it is interested in the return value of the fixture, as normal.</p> <h3 id=pytestmarkusefixtures><code>@pytest.mark.usefixtures</code><a class=headerlink href=#pytestmarkusefixtures title="Permanent link">&para;</a></h3> <p>The <code>@pytest.mark.usefixtures</code> mark can be used to apply one or more fixtures to tests, as if they have the fixture name declared in their parameter list. This can be an alternative in situations where you want all tests in a group to always use a fixture that is not <code>autouse</code>.</p> <p>For example, the code below will ensure all tests methods in the <code>TestVirtualEnv</code> class execute in a brand new virtual environment: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>venv_dir</span><span class=p>():</span>
    <span class=kn>import</span> <span class=nn>venv</span>

    <span class=k>with</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>TemporaryDirectory</span><span class=p>()</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
        <span class=n>venv</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
        <span class=n>pwd</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getcwd</span><span class=p>()</span>
        <span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
        <span class=k>yield</span> <span class=n>d</span>
        <span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=n>pwd</span><span class=p>)</span>

<span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>usefixtures</span><span class=p>(</span><span class=s1>&#39;venv_dir&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>TestVirtualEnv</span><span class=p>:</span>
    <span class=o>...</span>
</code></pre></div></p> <p>As the name indicates, you can pass multiple fixtures names to the decorator: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>usefixtures</span><span class=p>(</span><span class=s2>&quot;venv_dir&quot;</span><span class=p>,</span> <span class=s2>&quot;config_python_debug&quot;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>Test</span><span class=p>:</span>
    <span class=o>...</span>
</code></pre></div></p> <h3 id=parametrizing-fixtures>Parametrizing fixtures<a class=headerlink href=#parametrizing-fixtures title="Permanent link">&para;</a></h3> <p>Fixtures can also be parametrized directly. When a fixture is parametrized, all tests that use the fixture will now run multiple times, once for each parameter. This is an excellent tool to use when we have variants of a fixture and each test that uses the fixture should also run with all variants.</p> <p>Consider the following example: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>parametrize</span><span class=p>(</span>
    <span class=s2>&quot;serializer_class&quot;</span><span class=p>,</span>
    <span class=p>[</span><span class=n>JSONSerializer</span><span class=p>,</span> <span class=n>XMLSerializer</span><span class=p>,</span> <span class=n>YAMLSerializer</span><span class=p>],</span>
<span class=p>)</span>
<span class=k>class</span> <span class=nc>Test</span><span class=p>:</span>

    <span class=k>def</span> <span class=nf>test_quantity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serializer_class</span><span class=p>):</span>
        <span class=n>serializer</span> <span class=o>=</span> <span class=n>serializer_class</span><span class=p>()</span>
        <span class=n>quantity</span> <span class=o>=</span> <span class=n>Quantity</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=s2>&quot;m&quot;</span><span class=p>)</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>serialize_quantity</span><span class=p>(</span><span class=n>quantity</span><span class=p>)</span>
        <span class=n>new_quantity</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>deserialize_quantity</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>new_quantity</span> <span class=o>==</span> <span class=n>quantity</span>

    <span class=k>def</span> <span class=nf>test_pipe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serializer_class</span><span class=p>):</span>
        <span class=n>serializer</span> <span class=o>=</span> <span class=n>serializer_class</span><span class=p>()</span>
        <span class=n>pipe</span> <span class=o>=</span> <span class=n>Pipe</span><span class=p>(</span>
            <span class=n>length</span><span class=o>=</span><span class=n>Quantity</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=s2>&quot;m&quot;</span><span class=p>),</span> <span class=n>diameter</span><span class=o>=</span><span class=n>Quantity</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span> <span class=s2>&quot;cm&quot;</span><span class=p>)</span>
        <span class=p>)</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>serialize_pipe</span><span class=p>(</span><span class=n>pipe</span><span class=p>)</span>
       <span class=n>new_pipe</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>deserialize_pipe</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
       <span class=k>assert</span> <span class=n>new_pipe</span> <span class=o>==</span> <span class=n>pipe</span>
</code></pre></div></p> <p>We can update the example to parametrize on a fixture instead: <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>Test</span><span class=p>:</span>

    <span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>params</span><span class=o>=</span><span class=p>[</span><span class=n>JSONSerializer</span><span class=p>,</span> <span class=n>XMLSerializer</span><span class=p>,</span>
                            <span class=n>YAMLSerializer</span><span class=p>])</span>
    <span class=k>def</span> <span class=nf>serializer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>request</span><span class=o>.</span><span class=n>param</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>test_quantity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serializer</span><span class=p>):</span>
        <span class=n>quantity</span> <span class=o>=</span> <span class=n>Quantity</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=s2>&quot;m&quot;</span><span class=p>)</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>serialize_quantity</span><span class=p>(</span><span class=n>quantity</span><span class=p>)</span>
        <span class=n>new_quantity</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>deserialize_quantity</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>new_quantity</span> <span class=o>==</span> <span class=n>quantity</span>

    <span class=k>def</span> <span class=nf>test_pipe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serializer</span><span class=p>):</span>
        <span class=n>pipe</span> <span class=o>=</span> <span class=n>Pipe</span><span class=p>(</span>
            <span class=n>length</span><span class=o>=</span><span class=n>Quantity</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=s2>&quot;m&quot;</span><span class=p>),</span> <span class=n>diameter</span><span class=o>=</span><span class=n>Quantity</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span> <span class=s2>&quot;cm&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>serialize_pipe</span><span class=p>(</span><span class=n>pipe</span><span class=p>)</span>
        <span class=n>new_pipe</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>deserialize_pipe</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>new_pipe</span> <span class=o>==</span> <span class=n>pipe</span>
</code></pre></div></p> <p>Note the following:</p> <ul> <li>We pass a <code>params</code> parameter to the fixture definition.</li> <li>We access the parameter inside the fixture, using the <code>param</code> attribute of the special <code>request</code> object. This built-in fixture provides access to the requesting test function and the parameter when the fixture is parametrized. </li> <li>In this case, we instantiate the serializer inside the fixture, instead of explicitly in each test.</li> </ul> <p>As can be seen, parametrizing a fixture is very similar to parametrizing a test, but there is one key difference: by parametrizing a fixture we make all tests that use that fixture run against all the parametrized instances, making them an excellent solution for fixtures shared in <code>conftest.py</code> files.</p> <h3 id=using-marks-from-fixtures>Using marks from fixtures<a class=headerlink href=#using-marks-from-fixtures title="Permanent link">&para;</a></h3> <p>We can use the <code>request</code> fixture to access marks that are applied to test functions.</p> <p>Suppose we have an <code>autouse</code> fixture that always initializes the current locale to English: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>autouse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>setup_locale</span><span class=p>():</span>
    <span class=n>locale</span><span class=o>.</span><span class=n>setlocale</span><span class=p>(</span><span class=n>locale</span><span class=o>.</span><span class=n>LC_ALL</span><span class=p>,</span> <span class=s2>&quot;en_US&quot;</span><span class=p>)</span>
    <span class=k>yield</span>
    <span class=n>locale</span><span class=o>.</span><span class=n>setlocale</span><span class=p>(</span><span class=n>locale</span><span class=o>.</span><span class=n>LC_ALL</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>test_currency_us</span><span class=p>():</span>
    <span class=k>assert</span> <span class=n>locale</span><span class=o>.</span><span class=n>currency</span><span class=p>(</span><span class=mf>10.5</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;$10.50&quot;</span>
</code></pre></div></p> <p>But what if we want to use a different locale for just a few tests?</p> <p>One way to do that is to use a custom mark, and access the <code>mark</code> object from within our fixture: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>autouse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>setup_locale</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=n>mark</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>get_closest_marker</span><span class=p>(</span><span class=s2>&quot;change_locale&quot;</span><span class=p>)</span>
    <span class=n>loc</span> <span class=o>=</span> <span class=n>mark</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>mark</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s2>&quot;en_US&quot;</span>
    <span class=n>locale</span><span class=o>.</span><span class=n>setlocale</span><span class=p>(</span><span class=n>locale</span><span class=o>.</span><span class=n>LC_ALL</span><span class=p>,</span> <span class=n>loc</span><span class=p>)</span>
    <span class=k>yield</span>
    <span class=n>locale</span><span class=o>.</span><span class=n>setlocale</span><span class=p>(</span><span class=n>locale</span><span class=o>.</span><span class=n>LC_ALL</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

<span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>change_locale</span><span class=p>(</span><span class=s2>&quot;pt_BR&quot;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_currency_br</span><span class=p>():</span>
    <span class=k>assert</span> <span class=n>locale</span><span class=o>.</span><span class=n>currency</span><span class=p>(</span><span class=mf>10.5</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;R$ 10,50&quot;</span>
</code></pre></div></p> <p>Marks can be used that way to pass information to fixtures. Because it is somewhat implicit though, I recommend using it sparingly, because it might lead to hard-to-understand code.</p> <h3 id=built-in-fixtures>Built-in fixtures<a class=headerlink href=#built-in-fixtures title="Permanent link">&para;</a></h3> <h4 id=tmpdir><code>tmpdir</code><a class=headerlink href=#tmpdir title="Permanent link">&para;</a></h4> <p>The <code>tmpdir</code> function-scoped fixture provides an empty directory that is removed automatically at the end of each test. <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_empty</span><span class=p>(</span><span class=n>tmpdir</span><span class=p>):</span>
    <span class=k>assert</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>tmpdir</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>tmpdir</span><span class=p>)</span> <span class=o>==</span> <span class=p>[]</span>
</code></pre></div></p> <p>The fixture provides a <a href=http://py.readthedocs.io/en/latest/path.html target=_blank><code>py.local</code></a>object, from the <a href=http://py.readthedocs.io/ target=_blank><code>py</code></a> library, which provides convenient methods to deal with file paths, such as joining, reading, writing, getting the extension, and so on; it is similar in philosophy to the <a href=https://docs.python.org/3/library/pathlib.html target=_blank><code>pathlib.Path</code></a> object from the standard library. <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_save_curves</span><span class=p>(</span><span class=n>tmpdir</span><span class=p>):</span>
    <span class=n>data</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>values</span><span class=o>=</span><span class=p>[</span><span class=mi>225</span><span class=p>,</span> <span class=mi>300</span><span class=p>])</span>
    <span class=n>fn</span> <span class=o>=</span> <span class=n>tmpdir</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;somefile.json&#39;</span><span class=p>)</span>
    <span class=n>write_json</span><span class=p>(</span><span class=n>fn</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>fn</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;{&quot;status_code&quot;: 200, &quot;values&quot;: [225, 300]}&#39;</span>
</code></pre></div></p> <blockquote> <p><strong>Note</strong></p> <p>Why pytest use <code>py.local</code> instead of <code>pathlib.Path</code>? Pytest had been around for years before <code>pathlib.Path</code> came along and was incorporated into the standard library, and the py library was one the best solutions for path-like objects at the time. Core pytest developers are looking into how to adapt pytest to the now-standard <code>pathlib.Path</code> API.</p> </blockquote> <h4 id=tmpdir_factory><code>tmpdir_factory</code><a class=headerlink href=#tmpdir_factory title="Permanent link">&para;</a></h4> <p>The <code>tmpdir</code> fixture is very handy, but it is only function-scoped: this has the downside that it can only be used by other function-scoped fixtures.</p> <p>The <code>tmpdir_factory</code> fixture is a session-scoped fixture that allows creating empty and unique directories at any scope. This can be useful when we need to store data on to a disk in fixtures of other scopes, for example a session-scoped cache or a database file. <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s1>&#39;session&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>images_dir</span><span class=p>(</span><span class=n>tmpdir_factory</span><span class=p>):</span>
    <span class=n>directory</span> <span class=o>=</span> <span class=n>tmpdir_factory</span><span class=o>.</span><span class=n>mktemp</span><span class=p>(</span><span class=s1>&#39;images&#39;</span><span class=p>)</span>
    <span class=n>download_images</span><span class=p>(</span><span class=s1>&#39;https://example.com/samples.zip&#39;</span><span class=p>,</span> <span class=n>directory</span><span class=p>)</span>
    <span class=n>extract_images</span><span class=p>(</span><span class=n>directory</span> <span class=o>/</span> <span class=s1>&#39;samples.zip&#39;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>directory</span>
</code></pre></div></p> <p>Keep in mind however that a directory created by this fixture is shared and will only be deleted at the end of the test session. This means that tests should not modify the contents of the directory; otherwise, they risk affecting other tests.</p> <h4 id=monkeypatch><code>monkeypatch</code><a class=headerlink href=#monkeypatch title="Permanent link">&para;</a></h4> <p>In some situations, tests need features that are complex or hard to set up in a testing environment, for example:</p> <ul> <li>Clients to an external resource (for example GitHub&rsquo;s API), where access during testing might be impractical or too expensive</li> <li>Forcing a piece of code to behave as if on another platform, such as error handling</li> <li>Complex conditions or environments that are hard to reproduce locally or in the CI</li> </ul> <p>The <code>monkeypatch</code> fixture allows you to cleanly overwrite functions, objects, and dictionary entries of the system being tested with other objects and functions, undoing all changes during test teardown. For example: <div class=highlight><pre><span></span><code><span class=c1># login.py</span>
<span class=kn>import</span> <span class=nn>getpass</span>

<span class=k>def</span> <span class=nf>user_login</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getpass</span><span class=p>()</span>
    <span class=n>check_credentials</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
    <span class=o>...</span>
</code></pre></div></p> <p>In this code, user_login uses the <a href=https://docs.python.org/3/library/getpass.html target=_blank><code>getpass.getpass()</code></a> function from the standard library to prompt for the user&rsquo;s password in the most secure manner available in the system. It is hard to simulate the actual entering of the password during testing because getpass tries to read directly from the terminal (as opposed to from <code>sys.stdin</code>) when possible.</p> <p>We can use the monkeypatch fixture to bypass the call to getpass in the tests, transparently and without changing the application code: <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_login_success</span><span class=p>(</span><span class=n>monkeypatch</span><span class=p>):</span>
    <span class=n>monkeypatch</span><span class=o>.</span><span class=n>setattr</span><span class=p>(</span><span class=n>getpass</span><span class=p>,</span> <span class=s2>&quot;getpass&quot;</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=s2>&quot;valid-pass&quot;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>user_login</span><span class=p>(</span><span class=s2>&quot;test-user&quot;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>test_login_wrong_password</span><span class=p>(</span><span class=n>monkeypatch</span><span class=p>):</span>
    <span class=n>monkeypatch</span><span class=o>.</span><span class=n>setattr</span><span class=p>(</span><span class=n>getpass</span><span class=p>,</span> <span class=s2>&quot;getpass&quot;</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=s2>&quot;wrong-pass&quot;</span><span class=p>)</span>
    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=n>AuthenticationError</span><span class=p>,</span> <span class=n>match</span><span class=o>=</span><span class=s2>&quot;wrong password&quot;</span><span class=p>):</span>
        <span class=n>user_login</span><span class=p>(</span><span class=s2>&quot;test-user&quot;</span><span class=p>)</span>
</code></pre></div></p> <p>In the tests, we use monkeypatch.setattr to replace the real <code>getpass()</code> function of the <code>getpass</code> module with a dummy <code>lambda</code>, which returns a hard-coded password. In <code>test_login_success</code>, we return a known, good password to ensure the user can authenticate successfully, while in <code>test_login_wrong_password</code>, we use a bad password to ensure the authentication error is handled correctly. As mentioned before, the original <code>getpass()</code> function is restored automatically at the end of the test, ensuring we don&rsquo;t leak that change to other tests in the system.</p> <p>The monkeypatch fixture works by replacing an attribute of an object by another object (often called a mock), restoring the original object at the end of the test. A common problem when using this fixture is patching the wrong object, which causes the original function/object to be called instead of the mock one. If the above example would have been: <div class=highlight><pre><span></span><code><span class=c1># login.py</span>
<span class=kn>from</span> <span class=nn>getpass</span> <span class=kn>import</span> <span class=n>getpass</span>

<span class=k>def</span> <span class=nf>user_login</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>getpass</span><span class=p>()</span>
    <span class=n>check_credentials</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
    <span class=o>...</span>
</code></pre></div> our test cases would not work. As now we&rsquo;ve to mock the <code>getpass</code> attribute of <code>login.py</code> namespace instead of <code>getpass</code> namespace</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>login</span>

<span class=k>def</span> <span class=nf>test_login_success</span><span class=p>(</span><span class=n>monkeypatch</span><span class=p>):</span>
    <span class=n>monkeypatch</span><span class=o>.</span><span class=n>setattr</span><span class=p>(</span><span class=n>login</span><span class=p>,</span> <span class=s2>&quot;getpass&quot;</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=s2>&quot;valid-pass&quot;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>user_login</span><span class=p>(</span><span class=s2>&quot;test-user&quot;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>test_login_wrong_password</span><span class=p>(</span><span class=n>monkeypatch</span><span class=p>):</span>
    <span class=n>monkeypatch</span><span class=o>.</span><span class=n>setattr</span><span class=p>(</span><span class=n>login</span><span class=p>,</span> <span class=s2>&quot;getpass&quot;</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=s2>&quot;wrong-pass&quot;</span><span class=p>)</span>
    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=n>AuthenticationError</span><span class=p>,</span> <span class=n>match</span><span class=o>=</span><span class=s2>&quot;wrong password&quot;</span><span class=p>):</span>
        <span class=n>user_login</span><span class=p>(</span><span class=s2>&quot;test-user&quot;</span><span class=p>)</span>
</code></pre></div> <p>How the code being tested imports code that needs to be monkeypatched is the reason why people are tripped by this so often, so make sure you take a look at the code first.</p> <h4 id=capsys><code>capsys</code><a class=headerlink href=#capsys title="Permanent link">&para;</a></h4> <p>The <code>capsys</code> fixture captures all text written to <code>sys.stdout</code> and <code>sys.stderr</code> and makes it available during testing. The name is short for capture system streams.</p> <p>Suppose we have a small command-line script and want to check the usage instructions are correct when the script is invoked without arguments: <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>textwrap</span> <span class=kn>import</span> <span class=n>dedent</span>

<span class=k>def</span> <span class=nf>script_main</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>args</span><span class=p>:</span>
        <span class=n>show_usage</span><span class=p>()</span>
        <span class=k>return</span> <span class=mi>0</span>
    <span class=o>...</span>

<span class=k>def</span> <span class=nf>show_usage</span><span class=p>():</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Create/update webhooks.&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot; Usage: hooks REPO URL&quot;</span><span class=p>)</span>
</code></pre></div> During testing, we can access the captured output, using the capsys fixture. This fixture has a <code>capsys.readouterr()</code> method that returns a namedtuple with <code>out</code> and <code>err</code> attributes, containing the captured text from <code>sys.stdout</code> and <code>sys.stderr</code> respectively: <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_usage</span><span class=p>(</span><span class=n>capsys</span><span class=p>):</span>
    <span class=n>script_main</span><span class=p>([])</span>
    <span class=n>captured</span> <span class=o>=</span> <span class=n>capsys</span><span class=o>.</span><span class=n>readouterr</span><span class=p>()</span>
    <span class=k>assert</span> <span class=n>captured</span><span class=o>.</span><span class=n>out</span> <span class=o>==</span> <span class=n>dedent</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span><span class=se>\</span>
<span class=s2>        Create/update webhooks.</span>
<span class=s2>          Usage: hooks REPO URL</span>
<span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>
</code></pre></div></p> <h4 id=capfd><code>capfd</code><a class=headerlink href=#capfd title="Permanent link">&para;</a></h4> <p>There&rsquo;s also the <code>capfd</code> fixture that works similarly to <code>capsys</code>, except that it also captures the output of file descriptors <code>1</code> and <code>2</code>. This makes it possible to capture the standard output and standard errors, even for extension modules. The name is short for capture file desciptors.</p> <h4 id=capsysbinarycapfdbinary><code>capsysbinary</code>/<code>capfdbinary</code><a class=headerlink href=#capsysbinarycapfdbinary title="Permanent link">&para;</a></h4> <p><code>capsysbinary</code> and <code>capfdbinary</code> are fixtures identical to <code>capsys</code> and <code>capfd</code>, except that they capture output in binary mode, and their <code>readouterr()</code> methods return raw bytes instead of text. It might be useful in specialized situations, for example, when running an external process that produces binary output, such as <code>tar</code>.</p> <h4 id=request><code>request</code><a class=headerlink href=#request title="Permanent link">&para;</a></h4> <p>The <code>request</code> fixture is an internal pytest fixture that provides useful information about the requesting test. It can be declared in test functions and fixtures, and provides attributes such as the following:</p> <ul> <li><code>function</code>: the Python test function object, available for function-scoped fixtures.</li> <li><code>cls</code>/<code>instance</code>: the Python class/instance of a test method object, available for function- and class-scoped fixtures. It can be <code>None</code> if the fixture is being requested from a test function, as opposed to a test method.</li> <li><code>module</code>: the Python module object of the requesting test method, available for module-, function-, and class-scoped fixtures.</li> <li><code>session</code>: pytest&rsquo;s internal Session object, which is a singleton for the test session and represents the root of the collection tree. It is available to fixtures of all scopes.</li> <li><code>node</code>: the pytest collection node, which wraps one of the Python objects discussed that matches the fixture scope.</li> <li><code>addfinalizer(func)</code>: adds a new <code>finalizer</code> function that will be called at the end of the test. The <code>finalizer</code> function is called without arguments. <code>addfinalizer</code> was the original way to execute teardown in fixtures, but has since then been superseded by the <code>yield</code> statement, remaining in use mostly for backward compatibility.</li> </ul> <p>Fixtures can use those attributes to customize their own behavior based on the test being executed. For example, we can create a fixture that provides a temporary directory using the current test name as the prefix of the temporary directory, somewhat similar to the built-in <code>tmpdir</code> fixture: <div class=highlight><pre><span></span><code><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>tmp_path</span><span class=p>(</span><span class=n>request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Path</span><span class=p>:</span>
    <span class=k>with</span> <span class=n>TemporaryDirectory</span><span class=p>(</span><span class=n>prefix</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>name</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
        <span class=k>yield</span> <span class=n>Path</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>test_tmp_path</span><span class=p>(</span><span class=n>tmp_path</span><span class=p>):</span>
    <span class=k>assert</span> <span class=nb>list</span><span class=p>(</span><span class=n>tmp_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>())</span> <span class=o>==</span> <span class=p>[]</span>
</code></pre></div></p> <p>The <code>request</code> fixture can be used whenever you want to customize a fixture based on the attributes of the test being executed, or to access the marks applied to the test function, as we have seen in the previous sections.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2020-04-23T16:40:55+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2020-04-23</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.220ee61c.min.js></script> <script src=../../../../js/timeago.min.js></script> <script src=../../../../js/timeago_mkdocs_material.js></script> <script src=https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js></script> </body> </html>