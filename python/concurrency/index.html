<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is mickey mouse's notebook"><meta name=author content="Mickey Mouse"><link href=https://jinayshah.netlify.com/python/concurrency/ rel=canonical><link href=../profiling/ rel=prev><link href=../logging/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.3, mkdocs-material-9.1.18"><title>Concurrent Execution - Mickey Mouse's Notebook</title><link rel=stylesheet href=../../assets/stylesheets/main.26e3688c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,300i,400,400i,700,700i%7CHack:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto Mono";--md-code-font:"Hack"}</style><link rel=stylesheet href=../../css/timeago.css><link rel=stylesheet href=https://unpkg.com/mermaid@7.1.2/dist/mermaid.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#concurrent-execution class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Mickey Mouse's Notebook" class="md-header__button md-logo" aria-label="Mickey Mouse's Notebook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Mickey Mouse's Notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Concurrent Execution </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Mickey Mouse's Notebook" class="md-nav__button md-logo" aria-label="Mickey Mouse's Notebook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Mickey Mouse's Notebook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../functions/ class=md-nav__link> Functions </a> </li> <li class=md-nav__item> <a href=../decorators/ class=md-nav__link> Decorators </a> </li> <li class=md-nav__item> <a href=../oop/ class=md-nav__link> OOP </a> </li> <li class=md-nav__item> <a href=../iterators/ class=md-nav__link> Iterators </a> </li> <li class=md-nav__item> <a href=../files/ class=md-nav__link> Working with files </a> </li> <li class=md-nav__item> <a href=../custom-json/ class=md-nav__link> Custom JSON Encoder/Decoder </a> </li> <li class=md-nav__item> <a href=../pickling/ class=md-nav__link> Pickling </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex=0> Testing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Testing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../testing/introduction/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8_2> <label class=md-nav__link for=__nav_2_8_2 id=__nav_2_8_2_label tabindex=0> Pytest <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_8_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8_2> <span class="md-nav__icon md-icon"></span> Pytest </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../testing/pytest/tests/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../testing/pytest/markers/ class=md-nav__link> Markers </a> </li> <li class=md-nav__item> <a href=../testing/pytest/parametrization/ class=md-nav__link> Parametrization </a> </li> <li class=md-nav__item> <a href=../testing/pytest/fixtures/ class=md-nav__link> Fixtures </a> </li> <li class=md-nav__item> <a href=../testing/pytest/plugins/ class=md-nav__link> Plugins </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../testing/tox/ class=md-nav__link> Tox </a> </li> <li class=md-nav__item> <a href=../testing/coverage/ class=md-nav__link> Coverage </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../exceptions/ class=md-nav__link> Exceptions </a> </li> <li class=md-nav__item> <a href=../profiling/ class=md-nav__link> Profiling </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Concurrent Execution <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Concurrent Execution </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#types-of-thread class=md-nav__link> Types of thread </a> </li> <li class=md-nav__item> <a href=#states-of-thread class=md-nav__link> States of thread </a> </li> <li class=md-nav__item> <a href=#context-switching class=md-nav__link> Context switching </a> </li> <li class=md-nav__item> <a href=#the-global-interpreter-lock-gil class=md-nav__link> The Global Interpreter Lock (GIL) </a> </li> <li class=md-nav__item> <a href=#starting-a-thread class=md-nav__link> Starting a thread </a> </li> <li class=md-nav__item> <a href=#starting-a-process class=md-nav__link> Starting a process </a> </li> <li class=md-nav__item> <a href=#stopping-a-thread class=md-nav__link> Stopping a thread </a> </li> <li class=md-nav__item> <a href=#stopping-a-process class=md-nav__link> Stopping a process </a> </li> <li class=md-nav__item> <a href=#swapning-multiple-threads class=md-nav__link> Swapning multiple threads </a> </li> <li class=md-nav__item> <a href=#race-conditions class=md-nav__link> Race conditions </a> <nav class=md-nav aria-label="Race conditions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#simulate-race-condition class=md-nav__link> Simulate race condition </a> </li> <li class=md-nav__item> <a href=#fix-for-race-condition class=md-nav__link> Fix for race condition </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#a-threads-local-data class=md-nav__link> A thread's local data </a> </li> <li class=md-nav__item> <a href=#thread-communication-using-queues class=md-nav__link> Thread communication using queues </a> </li> <li class=md-nav__item> <a href=#thread-communication-using-sending-events class=md-nav__link> Thread communication using sending events </a> </li> <li class=md-nav__item> <a href=#inter-process-communication-with-queues class=md-nav__link> Inter-process communication with queues </a> </li> <li class=md-nav__item> <a href=#thread-and-process-pools class=md-nav__link> Thread and process pools </a> <nav class=md-nav aria-label="Thread and process pools"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#thread-pools class=md-nav__link> Thread pools </a> </li> <li class=md-nav__item> <a href=#process-pools class=md-nav__link> Process pools </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#examples class=md-nav__link> Examples </a> <nav class=md-nav aria-label=Examples> <ul class=md-nav__list> <li class=md-nav__item> <a href=#add-timeout-to-a-function class=md-nav__link> Add timeout to a function </a> </li> <li class=md-nav__item> <a href=#multithreadedmultiprocessing-mergesort class=md-nav__link> Multithreaded/Multiprocessing mergesort </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links class=md-nav__link> Links </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../logging/ class=md-nav__link> Logging </a> </li> <li class=md-nav__item> <a href=../references/ class=md-nav__link> References </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#types-of-thread class=md-nav__link> Types of thread </a> </li> <li class=md-nav__item> <a href=#states-of-thread class=md-nav__link> States of thread </a> </li> <li class=md-nav__item> <a href=#context-switching class=md-nav__link> Context switching </a> </li> <li class=md-nav__item> <a href=#the-global-interpreter-lock-gil class=md-nav__link> The Global Interpreter Lock (GIL) </a> </li> <li class=md-nav__item> <a href=#starting-a-thread class=md-nav__link> Starting a thread </a> </li> <li class=md-nav__item> <a href=#starting-a-process class=md-nav__link> Starting a process </a> </li> <li class=md-nav__item> <a href=#stopping-a-thread class=md-nav__link> Stopping a thread </a> </li> <li class=md-nav__item> <a href=#stopping-a-process class=md-nav__link> Stopping a process </a> </li> <li class=md-nav__item> <a href=#swapning-multiple-threads class=md-nav__link> Swapning multiple threads </a> </li> <li class=md-nav__item> <a href=#race-conditions class=md-nav__link> Race conditions </a> <nav class=md-nav aria-label="Race conditions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#simulate-race-condition class=md-nav__link> Simulate race condition </a> </li> <li class=md-nav__item> <a href=#fix-for-race-condition class=md-nav__link> Fix for race condition </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#a-threads-local-data class=md-nav__link> A thread's local data </a> </li> <li class=md-nav__item> <a href=#thread-communication-using-queues class=md-nav__link> Thread communication using queues </a> </li> <li class=md-nav__item> <a href=#thread-communication-using-sending-events class=md-nav__link> Thread communication using sending events </a> </li> <li class=md-nav__item> <a href=#inter-process-communication-with-queues class=md-nav__link> Inter-process communication with queues </a> </li> <li class=md-nav__item> <a href=#thread-and-process-pools class=md-nav__link> Thread and process pools </a> <nav class=md-nav aria-label="Thread and process pools"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#thread-pools class=md-nav__link> Thread pools </a> </li> <li class=md-nav__item> <a href=#process-pools class=md-nav__link> Process pools </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#examples class=md-nav__link> Examples </a> <nav class=md-nav aria-label=Examples> <ul class=md-nav__list> <li class=md-nav__item> <a href=#add-timeout-to-a-function class=md-nav__link> Add timeout to a function </a> </li> <li class=md-nav__item> <a href=#multithreadedmultiprocessing-mergesort class=md-nav__link> Multithreaded/Multiprocessing mergesort </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links class=md-nav__link> Links </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=concurrent-execution>Concurrent Execution<a class=headerlink href=#concurrent-execution title="Permanent link">&para;</a></h1> <h3 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h3> <p>A <strong>thread</strong> can be defined as a sequence of instructions that can be run by a <strong>scheduler</strong>, which is that part of the operating system that decides which chunk of work will receive the necessary resources to be carried out. Typically, a thread lives within a <strong>process</strong>. A <strong>process</strong> can be defined as an instance of a computer program that is being executed.</p> <h3 id=types-of-thread>Types of thread<a class=headerlink href=#types-of-thread title="Permanent link">&para;</a></h3> <ul> <li><strong>User-level threads</strong>: Threads that we can create and manage in order to perform a task.</li> <li><strong>Kernel-level threads</strong>: Low-level threads that run in kernel mode and act on behalf of the operating system.</li> </ul> <h3 id=states-of-thread>States of thread<a class=headerlink href=#states-of-thread title="Permanent link">&para;</a></h3> <ul> <li><strong>New thread</strong>: A thread that hasn&rsquo;t started yet, and hasn&rsquo;t been allocated any resources.</li> <li><strong>Runnable</strong>: The thread is waiting to run. It has all the resources needed to run, and as soon as the scheduler gives it the green light, it will be run.</li> <li><strong>Running</strong> :A thread whose stream of instructions is being executed. From this state, it can go back to a non-running state, or die.</li> <li><strong>Not-running</strong>: A thread that has been paused. This could be due to another thread taking precedence over it, or simply because the thread is waiting for a long-running IO operation to finish.</li> <li><strong>Dead</strong>: A thread that has died because it has reached the natural end of its stream of execution, or it has been killed.</li> </ul> <p><img alt="Thread state" src=https://lh4.googleusercontent.com/oR0_liUxjMnfgFS-fSuc0x2vCCPLQ0Vdw6w2rBVGloaE_84tRNprqNJEJiyI1unMY8Vpj2CDK9GiQGy03_RmteRz-aM31iIQcZsVZhIH2cLrne_5nY9miXKDmQqEHdY60_WopC0></p> <h3 id=context-switching>Context switching<a class=headerlink href=#context-switching title="Permanent link">&para;</a></h3> <p>The scheduler can decide when a thread can run, or is paused, and so on. Any time a running thread needs to be suspended so that another can be run, the scheduler saves the state of the running thread in a way that it will be possible, at a later time, to resume execution exactly where it was paused. This act is called <strong>context-switching</strong>.</p> <p>Context-switching is a marvelous ability of modern computers, but it can become troublesome if you generate too many threads. The scheduler then will try to give each of them a chance to run for a little time, and there will be a lot of time spent saving and recovering the state of the threads that are respectively paused and restarted.</p> <h3 id=the-global-interpreter-lock-gil>The Global Interpreter Lock (GIL)<a class=headerlink href=#the-global-interpreter-lock-gil title="Permanent link">&para;</a></h3> <p>The <strong>GIL</strong> is a mutex that protects access to Python objects, preventing multiple threads from executing Python bytecodes at once. This means that even though you can write multithreaded code in Python, there is only one thread per process running at any point in time.</p> <p>In computer programming, a <strong>mutual exclusion object (mutex)</strong> is a program object that allows multiple program threads to share the same resource, such as file access, but not simultaneously.</p> <h3 id=starting-a-thread>Starting a thread<a class=headerlink href=#starting-a-thread title="Permanent link">&para;</a></h3> <p><strong>Example 1:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>

<span class=k>def</span> <span class=nf>sum_and_product</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=n>s</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>+</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>s</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>*</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
    <span class=n>target</span><span class=o>=</span><span class=n>sum_and_product</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;SumProd&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
<span class=p>)</span>
<span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</code></pre></div></p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>3+7=10, 3*7=21
</code></pre></div></p> <p><strong>Example 2:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>

<span class=k>def</span> <span class=nf>sum_and_product</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=c1># There is a reason why I put .2 seconds of sleeping time within the</span>
    <span class=c1># function. When the thread starts, its first instruction is to sleep for a</span>
    <span class=c1># moment. The sneaky scheduler will catch that, and switch execution back</span>
    <span class=c1># to the main thread.     </span>
    <span class=n>sleep</span><span class=p>(</span><span class=mf>.2</span><span class=p>)</span>
    <span class=n>print_current</span><span class=p>()</span>
    <span class=n>s</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>+</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>s</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>*</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>status</span><span class=p>(</span><span class=n>t</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>t</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread </span><span class=si>{</span><span class=n>t</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1> is alive.&#39;</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread </span><span class=si>{</span><span class=n>t</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1> has terminated.&#39;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>print_current</span><span class=p>():</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;The current thread is </span><span class=si>{}</span><span class=s1>.&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
        <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span>
    <span class=p>))</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Threads: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>enumerate</span><span class=p>())))</span>

<span class=n>print_current</span><span class=p>()</span>
<span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
    <span class=n>target</span><span class=o>=</span><span class=n>sum_and_product</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;SumPro&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
<span class=p>)</span>
<span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>status</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
<span class=c1># `t.join()` instructs Python to block until the thread has completed. The</span>
<span class=c1># reason for that is because I want the last call to status(t) to tell us</span>
<span class=c1># that the thread is gone.</span>
<span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=n>status</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> 
</code></pre></div></p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>The current thread is &lt;_MainThread(MainThread, started 140735733822336)&gt;.
Threads: [&lt;_MainThread(MainThread, started 140735733822336)&gt;]
Thread SumProd is alive.
The current thread is &lt;Thread(SumProd, started 123145375604736)&gt;.
Threads: [
    &lt;_MainThread(MainThread, started 140735733822336)&gt;,
    &lt;Thread(SumProd, started 123145375604736)&gt;
]
3+7=10, 3*7=21
Thread SumProd has terminated.
</code></pre></div></p> <h3 id=starting-a-process>Starting a process<a class=headerlink href=#starting-a-process title="Permanent link">&para;</a></h3> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=c1># start_proc.py</span>
<span class=kn>import</span> <span class=nn>multiprocessing</span>

<span class=k>def</span> <span class=nf>sum_and_product</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=n>s</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>+</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>s</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>*</span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>multiprocessing</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span>
    <span class=n>target</span><span class=o>=</span><span class=n>sum_and_product</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;SumProdProc&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span>
<span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</code></pre></div> The output is also the same, except the numbers are different.</p> <h3 id=stopping-a-thread>Stopping a thread<a class=headerlink href=#stopping-a-thread title="Permanent link">&para;</a></h3> <p>Stopping a thread is a bad idea, and the same goes for a process. Being sure you&rsquo;ve taken care to dispose and close everything that is open can be quite difficult. However, there are situations in which you might want to be able to stop a thread. </p> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>

<span class=k>class</span> <span class=nc>Fibo</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>**</span><span class=n>kwa</span><span class=p>):</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>**</span><span class=n>kwa</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_running</span> <span class=o>=</span> <span class=kc>True</span>

    <span class=k>def</span> <span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_running</span> <span class=o>=</span> <span class=kc>False</span>

    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span>
        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>_running</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
            <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
            <span class=n>sleep</span><span class=p>(</span><span class=mf>0.07</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>()</span>

<span class=n>fibo</span> <span class=o>=</span> <span class=n>Fibo</span><span class=p>()</span>
<span class=n>fibo</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>fibo</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
<span class=n>fibo</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;All done.&#39;</span><span class=p>)</span>
</code></pre></div></p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>0 1 1 2 3 5 8 13 21 34 55 89 144 233
All done.
</code></pre></div></p> <p>When you write a thread using class, instead of giving it a target function, you simply override the <code>run</code> method in the class. When we call <code>fibo.stop()</code>, we aren&rsquo;t actually stopping the thread. We simply set our flag to <code>False</code>, and this allows the code within <code>run</code> to reach its natural end. This means that the thread will die organically.</p> <p>This is basically a workaround technique that allows you to stop a thread. If you design your code correctly according to multithreading paradigms, you shouldn&rsquo;t have to kill threads all the time, so let that need become your alarm bell that something could be designed better.</p> <h3 id=stopping-a-process>Stopping a process<a class=headerlink href=#stopping-a-process title="Permanent link">&para;</a></h3> <p>When it comes to stopping a process, things are different, and fuss-free. You can use either the <code>terminate</code> or <code>kill</code> method, but please make sure you know what you&rsquo;re doing, as all the preceding considerations about open resources left hanging are still true.</p> <h3 id=swapning-multiple-threads>Swapning multiple threads<a class=headerlink href=#swapning-multiple-threads title="Permanent link">&para;</a></h3> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>random</span>

<span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
    <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Hello from </span><span class=si>{</span><span class=n>t</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1>! (</span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
        <span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span> <span class=o>*</span> <span class=n>random</span><span class=p>())</span>

<span class=n>obi</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>run</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;Obi-Wan&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=p>))</span>
<span class=n>ani</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>run</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;Anakin&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=p>))</span>
<span class=n>obi</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>ani</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>obi</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=n>ani</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</code></pre></div></p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>$ python starwars.py
Hello from Obi-Wan! (0)
Hello from Anakin! (0)
Hello from Obi-Wan! (1)
Hello from Obi-Wan! (2)
Hello from Anakin! (1)
Hello from Obi-Wan! (3)
Hello from Anakin! (2)
</code></pre></div></p> <h3 id=race-conditions>Race conditions<a class=headerlink href=#race-conditions title="Permanent link">&para;</a></h3> <p>A <strong>race condition</strong> is a behavior of a system where the output of a procedure depends on the sequence or timing of other uncontrollable events. When these events don&rsquo;t unfold in the order intended by the programmer, a race condition becomes a bug.</p> <p>Imagine you have two threads running. Both are performing the same task, which consists of reading a value from a location, performing an action with that value, incrementing the value by 1 unit, and saving it back. Say that the action is to post that value to an API.</p> <p><strong>Scenario A</strong> – race condition not happening</p> <p>Thread <strong>A</strong> reads the value (<strong>1</strong>), posts <strong>1</strong> to the API, then increments it to <strong>2</strong>, and saves it back. Right after this, the scheduler pauses Thread <strong>A</strong>, and runs Thread <strong>B</strong>. Thread <strong>B</strong> reads the value (now <strong>2</strong>), posts <strong>2</strong> to the API, increments it to <strong>3</strong>, and saves it back.</p> <p>At this point, after the operation has happened twice, the value stored is correct: <strong>1 + 2 = 3</strong>. Moreover, the API has been called with both <strong>1</strong> and <strong>2</strong>, correctly.</p> <p><strong>Scenario B</strong> – race condition happening</p> <p>Thread <strong>A</strong> reads the value (<strong>1</strong>), posts it to the API, increments it to <strong>2</strong>, but before it can save it back, the scheduler decides to pause thread <strong>A</strong> in favor of Thread <strong>B</strong>. Thread <strong>B</strong> reads the value (still <strong>1</strong>!), posts it to the API,increments it to <strong>2</strong>, and saves it back. The scheduler then switches over to Thread <strong>A</strong> again. Thread <strong>A</strong> resumes its stream of work by simply saving the value it was holding after incrementing, which is <strong>2</strong>. After this scenario, even though the operation has happened twice as in Scenario <strong>A</strong>, the value saved is <strong>2</strong>, and the API has been called twice with <strong>1</strong>.</p> <h4 id=simulate-race-condition>Simulate race condition<a class=headerlink href=#simulate-race-condition title="Permanent link">&para;</a></h4> <p><strong>Code:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>random</span>

<span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>randsleep</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span> <span class=o>*</span> <span class=n>random</span><span class=p>())</span>

<span class=k>def</span> <span class=nf>incr</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>counter</span>
    <span class=k>for</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
        <span class=n>current</span> <span class=o>=</span> <span class=n>counter</span>
        <span class=n>randsleep</span><span class=p>()</span>
        <span class=n>counter</span> <span class=o>=</span> <span class=n>current</span> <span class=o>+</span> <span class=mi>1</span>
        <span class=n>randsleep</span><span class=p>()</span>

<span class=n>n</span> <span class=o>=</span> <span class=mi>5</span>
<span class=n>t1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>incr</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=p>))</span>
<span class=n>t2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>incr</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=p>))</span>
<span class=n>t1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>t2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>t1</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=n>t2</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Counter: </span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></div></p> <p>Here <code>counter</code> is the shared resource between threads <code>t1</code> and <code>t2</code>. <code>randsleep()</code> function is invoked after reading and writing to shared resource to mimic the real-life cost attached to dealing with resources. The value of <code>counter</code> variable should be <strong>10</strong>, but it rarely becomes <strong>10</strong> due to race condition.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Counter: 6
</code></pre></div></p> <h4 id=fix-for-race-condition>Fix for race condition<a class=headerlink href=#fix-for-race-condition title="Permanent link">&para;</a></h4> <p><strong>Code:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>random</span>

<span class=n>incr_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
<span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>randsleep</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span> <span class=o>*</span> <span class=n>random</span><span class=p>())</span>

<span class=k>def</span> <span class=nf>incr</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>counter</span>
    <span class=k>for</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
        <span class=k>with</span> <span class=n>incr_lock</span><span class=p>:</span>
            <span class=n>current</span> <span class=o>=</span> <span class=n>counter</span>
            <span class=n>randsleep</span><span class=p>()</span>
            <span class=n>counter</span> <span class=o>=</span> <span class=n>current</span> <span class=o>+</span> <span class=mi>1</span>
            <span class=n>randsleep</span><span class=p>()</span>

<span class=n>n</span> <span class=o>=</span> <span class=mi>5</span>
<span class=n>t1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>incr</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=p>))</span>
<span class=n>t2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>incr</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=p>))</span>
<span class=n>t1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>t2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>t1</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=n>t2</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Counter: </span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></div></p> <p>This time we have created a lock, from the <code>threading.Lock</code> class. We could call its <code>acquire</code> and <code>release</code> methods manually, or we can be Pythonic and use it within a context manager, which looks much nicer, and does the whole acquire/release business for us.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Counter: 10
</code></pre></div></p> <h3 id=a-threads-local-data>A thread&rsquo;s local data<a class=headerlink href=#a-threads-local-data title="Permanent link">&para;</a></h3> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>

<span class=n>local</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>local</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>local</span><span class=p>,</span> <span class=n>barrier</span><span class=p>):</span>
    <span class=n>local</span><span class=o>.</span><span class=n>my_value</span> <span class=o>=</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
    <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread </span><span class=si>{</span><span class=n>t</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1> has value </span><span class=si>{</span><span class=n>local</span><span class=o>.</span><span class=n>my_value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>barrier</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread </span><span class=si>{</span><span class=n>t</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1> still has value </span><span class=si>{</span><span class=n>local</span><span class=o>.</span><span class=n>my_value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>count</span> <span class=o>=</span> <span class=mi>3</span>
<span class=n>barrier</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Barrier</span><span class=p>(</span><span class=n>count</span><span class=p>)</span>
<span class=n>threads</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
        <span class=n>target</span><span class=o>=</span><span class=n>run</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;T</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>local</span><span class=p>,</span> <span class=n>barrier</span><span class=p>)</span>
    <span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>)</span>
<span class=p>]</span>
<span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</code></pre></div></p> <p>We start by defining <code>local</code>. That is the special object that holds thread-specific data. We run three threads. Each of them will assign a random value to <code>local.my_value</code>, and print it. Then the thread reaches a <code>Barrier</code> object, which is programmed to hold three threads in total. When the barrier is hit by the third thread, they all can pass. It&rsquo;s basically a nice way to make sure that <strong>N</strong> amount of threads reach a certain point and they all wait until every single one of them has arrived.</p> <p>Now, if <code>local</code> was a normal, dummy object, the second thread would override the value of <code>local.my_value</code>, and the third would do the same. This means that we would see them printing different values in the first set of prints, but they would show the same value (the last one) in the second round of prints. But that doesn&rsquo;t happen, thanks to <code>local</code>. The output shows the following:</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Thread T0 has value 61
Thread T1 has value 52
Thread T2 has value 38
Thread T2 still has value 38
Thread T0 still has value 61
Thread T1 still has value 52
</code></pre></div></p> <h3 id=thread-communication-using-queues>Thread communication using queues<a class=headerlink href=#thread-communication-using-queues title="Permanent link">&para;</a></h3> <p><strong>Code:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>Queue</span>

<span class=n>SENTINEL</span> <span class=o>=</span> <span class=nb>object</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span>
    <span class=k>while</span> <span class=n>a</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>:</span>
        <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
        <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>SENTINEL</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=n>num</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
        <span class=n>q</span><span class=o>.</span><span class=n>task_done</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>num</span> <span class=ow>is</span> <span class=n>SENTINEL</span><span class=p>:</span>
            <span class=k>break</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Got number </span><span class=si>{</span><span class=n>num</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>q</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
<span class=n>cns</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=p>))</span>
<span class=n>prd</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>35</span><span class=p>))</span>
<span class=n>cns</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>prd</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>q</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</code></pre></div></p> <p>The <strong>producer</strong> generates fibonacci numbers till <code>n</code> and puts them in the <code>queue</code> and adds a <code>SENTINEL</code> object at the last. A <code>SENTINEL</code> is any object that is used to signal something, and in our case, it signals to the consumer that the producer is done. The <strong>consumer</strong> receives objects from queue and marks the object as processed using <code>q.task_done()</code> and when object is <code>SENTINEL</code> it stops. The purpose of using <code>q.task_done()</code> is to allow the final instruction in the code to unblock when all elements have been acknowledged, so that the execution can end.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Got numer 0
Got numer 1
...
Got numer 34
</code></pre></div></p> <h3 id=thread-communication-using-sending-events>Thread communication using sending events<a class=headerlink href=#thread-communication-using-sending-events title="Permanent link">&para;</a></h3> <p>Another way to make threads communicate is to fire events.</p> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>threading</span>

<span class=k>def</span> <span class=nf>fire</span><span class=p>():</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Firing event...&#39;</span><span class=p>)</span>
    <span class=n>event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>listen</span><span class=p>():</span>
    <span class=n>event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Event has been fired&#39;</span><span class=p>)</span>

<span class=n>event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
<span class=n>t1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>fire</span><span class=p>)</span>
<span class=n>t2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>listen</span><span class=p>)</span>
<span class=n>t2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>t1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</code></pre></div></p> <p>Here we have two threads that run <code>fire</code> and <code>listen</code>, respectively firing and listening for an event. To fire an event, call the <code>set</code> method on it. The <code>t2</code> thread, which is started first, is already listening to the event, and will sit there until the event is fired. Events are great in some situations. Think about having threads that are waiting on a connection object to be ready, before they can actually start using it. They could be waiting on an event, and one thread could be checking that connection, and firing the event when it&rsquo;s ready.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Firing event...
Event has been fired
</code></pre></div></p> <h3 id=inter-process-communication-with-queues>Inter-process communication with queues<a class=headerlink href=#inter-process-communication-with-queues title="Permanent link">&para;</a></h3> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>multiprocessing</span>

<span class=n>SENTINEL</span> <span class=o>=</span> <span class=s1>&#39;STOP&#39;</span>

<span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span>
    <span class=k>while</span> <span class=n>a</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>:</span>
        <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
        <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>SENTINEL</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=n>num</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>num</span> <span class=o>==</span> <span class=n>SENTINEL</span><span class=p>:</span>
            <span class=k>break</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Got number </span><span class=si>{</span><span class=n>num</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>q</span> <span class=o>=</span> <span class=n>multiprocessing</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<span class=n>cns</span> <span class=o>=</span> <span class=n>multiprocessing</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=p>))</span>
<span class=n>prd</span> <span class=o>=</span> <span class=n>multiprocessing</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=mi>35</span><span class=p>))</span>
<span class=n>cns</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=n>prd</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</code></pre></div></p> <p>The code is very similar to the thread communication using queues. In this case, we have to use a queue that is an instance of <code>multiprocessing.Queue</code>, which doesn&rsquo;t expose a <code>task_done</code> method. However, because of the way this queue is designed, it automatically joins the main thread, therefore we only need to start the two processes and all will work.</p> <p>When it comes to inter-process communication objects are pickled when they enter the queue, so IDs get lost. That&rsquo;s why an <code>object</code> is not used as a <code>SENTINEL</code> and a string <code>"STOP"</code> is used to do the trick as we&rsquo;re dealing with numbers. The key is to use something we&rsquo;re not expecting at all.</p> <p>Queues aren&rsquo;t the only way to communicate between processes. You can also use pipes (<code>multiprocessing.Pipe</code>), which provide a connection (as in, a pipe , clearly) from one process to another, and vice versa.</p> <h3 id=thread-and-process-pools>Thread and process pools<a class=headerlink href=#thread-and-process-pools title="Permanent link">&para;</a></h3> <p><strong>Pools</strong> are structures designed to hold <strong>N</strong> objects (threads, processes, and so on). When the usage reaches capacity, no work is assigned to a thread (or process) until one of those currently working becomes available again. Pools, therefore, are a great way to limit the number of threads (or processes) that can be alive at the same time, preventing the system from starving due to resource exhaustion, or the computation time from being affected by too much context switching.</p> <p>The <code>ThreadPoolExecutor</code> and <code>ProcessPoolExecutor</code> are two classes from <code>concurrent.futures</code>, use a pool of threads (and processes, respectively), to execute calls asynchronously. They both accept a parameter, <code>max_workers</code>, which sets the upper limit to how many threads (or processes) can be used at the same time by the executor.</p> <h4 id=thread-pools>Thread pools<a class=headerlink href=#thread-pools title="Permanent link">&para;</a></h4> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ThreadPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>
<span class=kn>import</span> <span class=nn>threading</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>

<span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
    <span class=n>sleep</span><span class=p>(</span><span class=mf>.05</span><span class=p>)</span>
    <span class=n>value</span> <span class=o>=</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
    <span class=n>tname</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Hi, I am </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>tname</span><span class=si>}</span><span class=s1>) and my value is </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>

<span class=k>with</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
    <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span>
        <span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;T</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
    <span class=p>]</span>
    <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
        <span class=n>name</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> returned </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></div></p> <p>We define a list of future objects by making a list comprehension, in which we call <code>submit</code> on our executor object. We instruct the executor to run the <code>run</code> function, with a name that will go from <code>T0</code> to <code>T4</code>. A <code>future</code> is an object that encapsulates the asynchronous execution of a callable. Then we loop over the <code>future</code> objects, as they are done. To do this, we use <code>as_completed</code> to get an iterator of the <code>future</code> instances that returns them as soon as they complete (finish or were cancelled). We grab the result of each <code>future</code> by calling the <code>result</code> method, and simply print it. We sleep for <strong>50</strong> milliseconds at the beginning of each <code>run</code>. This is to exacerbate the behavior and have the output clearly show the size of the pool, which is still three.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Hi, I am T0 (ThreadPoolExecutor-0_0) and my value is 81
Hi, I am T1 (ThreadPoolExecutor-0_1) and my value is 44
Thread T0 returned 81
Thread T1 returned 44
Hi, I am T2 (ThreadPoolExecutor-0_2) and my value is 26
Thread T2 returned 26
Hi, I am T3 (ThreadPoolExecutor-0_0) and my value is 15
Hi, I am T4 (ThreadPoolExecutor-0_1) and my value is 87
Thread T3 returned 15
Thread T4 returned 87
</code></pre></div></p> <p>So, what goes on is that three threads start running, so we get three <code>Hi, I am...</code> messages printed out. Once all three of them are running, the pool is at capacity, so we need to wait for at least one thread to complete before anything else can happen. In the example run, <code>T0</code> and <code>T1</code> complete (which is signaled by the printing of what they returned), so they return to the pool and can be used again. They get run with names <code>T3</code> and <code>T4</code>, and finally all three, <code>T2</code>, <code>T3</code>, and <code>T4</code> complete. It can be seen from the output how the threads are actually reused, and how the first two are reassigned to <code>T3</code> and <code>T4</code> after they complete.</p> <h4 id=process-pools>Process pools<a class=headerlink href=#process-pools title="Permanent link">&para;</a></h4> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ProcessPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
<span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>

<span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
    <span class=n>sleep</span><span class=p>(</span><span class=mf>.05</span><span class=p>)</span>
    <span class=n>value</span> <span class=o>=</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Hi, I am </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> and my value is </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>

<span class=k>with</span> <span class=n>ProcessPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
    <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span>
        <span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;P</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
    <span class=p>]</span>
    <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
        <span class=n>name</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Process </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> returned </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></div></p> <p>The difference is truly minimal. We use <code>ProcessPoolExecutor</code> this time, and the <code>run</code> function is exactly the same.</p> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>Hi, I am P0 and my value is 19
Hi, I am P1 and my value is 97
Hi, I am P2 and my value is 74
Process P0 returned 19
Process P1 returned 97
Process P2 returned 74
Hi, I am P3 and my value is 80
Hi, I am P4 and my value is 68
Process P3 returned 80
Process P4 returned 68
</code></pre></div></p> <h3 id=examples>Examples<a class=headerlink href=#examples title="Permanent link">&para;</a></h3> <h4 id=add-timeout-to-a-function>Add timeout to a function<a class=headerlink href=#add-timeout-to-a-function title="Permanent link">&para;</a></h4> <p>Most, if not all, libraries that expose functions to make HTTP requests, provide the ability to specify a timeout when performing the request. This means that if after <strong>X</strong> seconds (<strong>X</strong> being the timeout), the request hasn&rsquo;t completed, the whole operation is aborted and execution resumes from the next instruction. Not all functions expose this feature though, so, when a function doesn&rsquo;t provide the ability to being interrupted, we can use a process to simulate that behavior. In this example, we&rsquo;ll be trying to translate a hostname into an IPv4 address. The <code>gethostbyname</code> function, from the <code>socket</code> module, doesn&rsquo;t allow us to put a timeout on the operation though, so we use a process to do that artificially.</p> <p><strong>Code:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>socket</span>
<span class=kn>from</span> <span class=nn>multiprocessing</span> <span class=kn>import</span> <span class=n>Process</span><span class=p>,</span> <span class=n>Queue</span>

<span class=k>def</span> <span class=nf>gethostbyname</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=n>queue</span><span class=p>):</span>
    <span class=n>ip</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>gethostbyname</span><span class=p>(</span><span class=n>hostname</span><span class=p>)</span>
    <span class=n>queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>ip</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>resolve_host</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=n>timeout</span><span class=p>):</span>
    <span class=n>queue</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
    <span class=n>proc</span> <span class=o>=</span> <span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>gethostbyname</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=n>queue</span><span class=p>))</span>
    <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
    <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>queue</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
        <span class=n>proc</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
        <span class=n>ip</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>ip</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
    <span class=k>return</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span><span class=p>,</span> <span class=n>ip</span>

<span class=k>def</span> <span class=nf>resolve</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
    <span class=n>exitcode</span><span class=p>,</span> <span class=n>ip</span> <span class=o>=</span> <span class=n>resolve_host</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=n>timeout</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>exitcode</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>ip</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>hostname</span>
</code></pre></div> <p>In the successful scenario, the call to <code>socket.gethostbyname</code> succeeds quickly, the IP is in the queue, the process terminates well before its timeout time, and when we get to the <code>if</code> part, the queue will not be empty. We fetch the IP from it, and return it, alongside the process exit code.</p> <p>In the unsuccessful scenario, the call to <code>socket.gethostbyname</code> takes too long, and the process is killed after its timeout has expired. Because the call failed, no IP has been inserted in the queue, and therefore it will be empty. In the <code>if</code> logic, we therefore set the IP to <code>None</code>, and return as before. The <code>resolve</code> function will find that the exit code is not <code>0</code> (as the process didn&rsquo;t terminate happily, but was killed instead), and will correctly return the hostname instead of the IP, which we couldn&rsquo;t get anyway.</p> <h4 id=multithreadedmultiprocessing-mergesort>Multithreaded/Multiprocessing mergesort<a class=headerlink href=#multithreadedmultiprocessing-mergesort title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>shuffle</span>
<span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>reduce</span>
<span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>ProcessPoolExecutor</span><span class=p>,</span>
    <span class=n>ThreadPoolExecutor</span><span class=p>,</span>
    <span class=n>as_completed</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>process_time</span>


<span class=k>def</span> <span class=nf>sort</span><span class=p>(</span><span class=n>lt</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=n>parts</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>6</span><span class=p>):</span>
    <span class=k>assert</span> <span class=n>parts</span> <span class=o>&gt;</span> <span class=mi>1</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>lt</span>
    <span class=n>chunk_size</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>//</span> <span class=n>parts</span><span class=p>)</span>
    <span class=n>sorted_chunks</span> <span class=o>=</span> <span class=p>[</span><span class=n>sort</span><span class=p>(</span><span class=n>lt</span><span class=p>[</span><span class=n>k</span><span class=p>:</span><span class=n>k</span> <span class=o>+</span> <span class=n>chunk_size</span><span class=p>])</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span>
                     <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>),</span> <span class=n>chunk_size</span><span class=p>)]</span>
    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=n>merge</span><span class=p>,</span> <span class=n>sorted_chunks</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>sort_multithreading</span><span class=p>(</span><span class=n>lt</span><span class=p>,</span> <span class=n>workers</span><span class=o>=</span><span class=mi>6</span><span class=p>):</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>lt</span>
    <span class=n>chunk_size</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>//</span> <span class=n>workers</span><span class=p>)</span>
    <span class=n>chunks</span> <span class=o>=</span> <span class=p>[</span><span class=n>lt</span><span class=p>[</span><span class=n>k</span><span class=p>:</span><span class=n>k</span> <span class=o>+</span> <span class=n>chunk_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>),</span> <span class=n>chunk_size</span><span class=p>)]</span>
    <span class=k>with</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=n>workers</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
        <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span>
            <span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>sort</span><span class=p>,</span> <span class=n>chunk</span><span class=p>)</span> <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>chunks</span>
        <span class=p>]</span>
    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=n>merge</span><span class=p>,</span> <span class=p>(</span><span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span> <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>)))</span>


<span class=k>def</span> <span class=nf>sort_multiprocessing</span><span class=p>(</span><span class=n>lt</span><span class=p>,</span> <span class=n>workers</span><span class=o>=</span><span class=mi>6</span><span class=p>):</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>lt</span>
    <span class=n>chunk_size</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span> <span class=o>//</span> <span class=n>workers</span><span class=p>)</span>
    <span class=n>chunks</span> <span class=o>=</span> <span class=p>[</span><span class=n>lt</span><span class=p>[</span><span class=n>k</span><span class=p>:</span><span class=n>k</span> <span class=o>+</span> <span class=n>chunk_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt</span><span class=p>),</span> <span class=n>chunk_size</span><span class=p>)]</span>
    <span class=k>with</span> <span class=n>ProcessPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=n>workers</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
        <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span>
            <span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>sort</span><span class=p>,</span> <span class=n>chunk</span><span class=p>)</span> <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>chunks</span>
        <span class=p>]</span>
    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=n>merge</span><span class=p>,</span> <span class=p>(</span><span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span> <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>)))</span>


<span class=k>def</span> <span class=nf>merge</span><span class=p>(</span><span class=n>lt1</span><span class=p>,</span> <span class=n>lt2</span><span class=p>):</span>
    <span class=n>lt</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>start_1</span> <span class=o>=</span> <span class=n>start_2</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>while</span> <span class=n>start_1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt1</span><span class=p>)</span> <span class=ow>and</span> <span class=n>start_2</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt2</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>lt1</span><span class=p>[</span><span class=n>start_1</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>lt2</span><span class=p>[</span><span class=n>start_2</span><span class=p>]:</span>
            <span class=n>lt</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>lt1</span><span class=p>[</span><span class=n>start_1</span><span class=p>])</span>
            <span class=n>start_1</span> <span class=o>+=</span> <span class=mi>1</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>lt</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>lt2</span><span class=p>[</span><span class=n>start_2</span><span class=p>])</span>
            <span class=n>start_2</span> <span class=o>+=</span> <span class=mi>1</span>
    <span class=k>if</span> <span class=n>start_1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt1</span><span class=p>):</span>
        <span class=n>lt</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>lt1</span><span class=p>[</span><span class=n>start_1</span><span class=p>:])</span>
    <span class=k>elif</span> <span class=n>start_2</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lt2</span><span class=p>):</span>
        <span class=n>lt</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>lt2</span><span class=p>[</span><span class=n>start_2</span><span class=p>:])</span>
    <span class=k>return</span> <span class=n>lt</span>


<span class=k>def</span> <span class=nf>calculate_time</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=n>start_time</span> <span class=o>=</span> <span class=n>process_time</span><span class=p>()</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
        <span class=n>elapsed_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>process_time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> elapsed in </span><span class=si>{</span><span class=n>elapsed_time</span><span class=si>}</span><span class=s2> milliseconds&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>result</span>

    <span class=k>return</span> <span class=n>wrapper</span>


<span class=k>def</span> <span class=nf>performance_measurement_and_testing</span><span class=p>():</span>
    <span class=k>for</span> <span class=n>lt_length</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=mi>1000000</span><span class=p>,):</span>
        <span class=n>lt_orig</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>lt_length</span><span class=p>))</span>
        <span class=n>lt</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>lt_orig</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;List length: </span><span class=si>{</span><span class=n>lt_length</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=n>shuffle</span><span class=p>(</span><span class=n>lt</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>func</span> <span class=ow>in</span> <span class=p>(</span><span class=n>sort</span><span class=p>,</span> <span class=n>sort_multithreading</span><span class=p>,</span> <span class=n>sort_multiprocessing</span><span class=p>):</span>
            <span class=n>sorted_lt</span> <span class=o>=</span> <span class=n>calculate_time</span><span class=p>(</span><span class=n>func</span><span class=p>)(</span><span class=n>lt</span><span class=p>)</span>
            <span class=k>assert</span> <span class=n>sorted_lt</span> <span class=o>==</span> <span class=n>lt_orig</span>

<span class=n>performance_measurement_and_testing</span><span class=p>()</span>
</code></pre></div> <p><strong>Output:</strong> <div class=highlight><pre><span></span><code>List length: 4
sort elapsed in 0.029448999999986958 milliseconds
sort_multithreading elapsed in 2.796734000000023 milliseconds
sort_multiprocessing elapsed in 8.03862999999999 milliseconds
List length: 1000
sort elapsed in 3.742769000000007 milliseconds
sort_multithreading elapsed in 6.403607000000005 milliseconds
sort_multiprocessing elapsed in 9.161322 milliseconds
List length: 1000000
sort elapsed in 8895.442821999999 milliseconds
sort_multithreading elapsed in 8808.045813 milliseconds
sort_multiprocessing elapsed in 1428.9983950000008 milliseconds
</code></pre></div></p> <p>This is a good example to show you a consequence of choosing multiprocessing approach over multithreading. Because the code is CPU-intensive, and there is no IO going on, splitting the list and having threads working the chunks doesn&rsquo;t add any advantage. On the other hand, using processes does. I used six workers in the multiprocessing version, Remember to parallelize proportionately to the amount of cores your processor has.</p> <h3 id=links>Links<a class=headerlink href=#links title="Permanent link">&para;</a></h3> <ul> <li><a href=https://docs.python.org/3/library/threading.html target=_blank>Python library</a></li> <li><a href="https://www.youtube.com/watch?v=9zinZmE3Ogk" target=_blank>Raymond Hettinger, Keynote on Concurrency, PyBay 2017</a></li> </ul> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2020-04-26T11:07:28+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2020-04-26</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.220ee61c.min.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> <script src=https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js></script> </body> </html>